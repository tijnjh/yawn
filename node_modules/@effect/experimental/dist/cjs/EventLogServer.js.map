{"version":3,"file":"EventLogServer.js","names":["HttpServerRequest","_interopRequireWildcard","require","HttpServerResponse","MsgPack","Chunk","Context","Effect","FiberMap","Layer","Mailbox","PubSub","RcMap","Schema","Uuid","_EventJournal","_EventLogEncryption","_EventLogRemote","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","constChunkSize","makeHandler","exports","gen","storage","Storage","remoteId","getId","chunkId","handler","socket","subscriptions","make","writeRaw","writer","chunks","Map","latestSequence","writeGen","response","data","encodeResponse","_tag","byteLength","id","part","ChunkedMessage","split","write","fork","Hello","handleRequest","request","Pong","encryptedEntries","length","Ack","sequenceNumbers","entries","map","encryptedEntry","entryId","PersistedEntry","iv","encrypted","publicKey","sequence","changes","startSequence","takeAll","pipe","flatMap","latestEntries","entry","push","void","Changes","toReadonlyArray","forever","scoped","run","remove","join","decodeRequest","catchAllCause","logDebug","annotateLogs","module","makeHandlerHttp","upgrade","empty","Class","EntryId","Uint8ArrayFromSelf","fromMsgPack","schema","encode","encodeSync","entryIdString","stringify","Tag","makeStorageMemory","knownIds","journals","makeRemoteId","ensureJournal","journal","pubsubs","lookup","_publicKey","acquireRelease","unbounded","shutdown","idleTimeToLive","of","succeed","active","keys","pubsub","includes","undefined","idString","EncryptedRemoteEntry","unsafeOffer","sync","slice","mailbox","queue","subscribe","offerAll","takeBetween","Number","MAX_SAFE_INTEGER","tap","chunk","forkScoped","interruptible","layerStorageMemory"],"sources":["../../src/EventLogServer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}