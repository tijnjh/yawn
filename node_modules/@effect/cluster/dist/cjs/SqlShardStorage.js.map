{"version":3,"file":"SqlShardStorage.js","names":["SqlClient","_interopRequireWildcard","require","Arr","Effect","Layer","_ClusterError","ShardStorage","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","withTracerDisabled","withTracerEnabled","make","exports","fnUntraced","options","sql","withoutTransforms","prefix","table","name","runnersTable","runnersTableSql","onDialectOrElse","mssql","mysql","pg","orElse","shardsTable","shardsTableSql","locksTable","locksTableSql","sqlNowString","sqlNow","literal","lockExpiresAt","acquireLock","address","values","csv","_address","unprepared","wrapString","s","wrapStringArr","arr","map","join","refreshShards","shardIds","shardIdsStr","pipe","rows","row","shard_id","makeEncoded","getAssignments","PersistenceError","refail","saveAssignments","assignments","remove","length","shardId","andThen","withTransaction","getRunners","runner","String","saveRunners","runners","insert","acquire","currentLocks","refresh","succeed","release","releaseAll","layer","effect","layerWith","scoped"],"sources":["../../src/SqlShardStorage.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}